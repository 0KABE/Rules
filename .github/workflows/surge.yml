name: Convert Rules to Surge Rule-Set

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *"
  push:
    branches: 
      - master
    paths-ignore:
      - "**/README.md"

permissions:
  contents: write

jobs:
  update-rules:
    name: Generate and Deploy Rules
    runs-on: ubuntu-latest
    steps:
      - name: Checkout release branch
        uses: actions/checkout@v4
        with:
          ref: release
          path: release-repo

      - name: Checkout GeoIP source
        uses: actions/checkout@v4
        with:
          repository: Loyalsoldier/geoip
          ref: release
          path: geoip-src

      - name: Setup Tools and GeoSite
        run: |
          wget -q https://github.com/MetaCubeX/geo/releases/download/v1.1/geo-linux-amd64 -O geo-tool
          chmod +x geo-tool
          wget -q https://github.com/Loyalsoldier/v2ray-rules-dat/releases/latest/download/geosite.dat

      - name: Process GeoIP Rules
        run: |
          TARGET_DIR="release-repo/geo_ip/surge"
          mkdir -p "$TARGET_DIR"
          rm -f "$TARGET_DIR"/*.list
          
          for file in geoip-src/surge/*.txt; do
            filename=$(basename "$file" .txt)
            cp $file "$TARGET_DIR/${filename}.list"
          done

      - name: Process GeoSite Rules
        run: |
          # Unpack GeoSite
          mkdir -p raw-geosite
          ./geo-tool unpack site geosite.dat -d raw-geosite/
          
          TARGET_DIR="release-repo/geo_site/surge"
          mkdir -p "$TARGET_DIR"
          rm -rf "release-repo/geo_site/"*
          mkdir -p "$TARGET_DIR"
          
          cd raw-geosite
          for file in *; do
            # Concatenate included files if they exist
            includes=$(grep "include:" "$file" | sed "s/include://g")
            # shellcheck disable=SC2086
            sed '' $includes "$file" > "$file.tmp" 2>/dev/null || cat "$file" > "$file.tmp"
            
            # Convert to Surge format
            grep "domain:" "$file.tmp" | sed -e "s/domain:/DOMAIN-SUFFIX,/g" -e "s/ @.*//g" > "../$TARGET_DIR/$file.list"
            grep "keyword:" "$file.tmp" | sed -e "s/keyword:/DOMAIN-KEYWORD,/g" -e "s/ @.*//g" >> "../$TARGET_DIR/$file.list"
            grep "full:" "$file.tmp" | sed -e "s/full:/DOMAIN,/g" -e "s/ @.*//g" >> "../$TARGET_DIR/$file.list"
            rm "$file.tmp"
          done

      - name: Deploy to Release Branch
        run: |
          cd release-repo
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add .
          if git diff --staged --quiet; then
            echo "No changes to deploy."
          else
            git commit -m "Update rules: $(date -u +'%Y-%m-%d %H:%M:%S') UTC"
            git push origin release
          fi
