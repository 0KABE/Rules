name: Convert Geosite to Surge Rule-Set

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *"
  push:
    branches: 
      - master
    paths-ignore:
      - "**/README.md"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Working Dirs
        run: |
          mkdir v2rules surgerules
          chmod 755 v2rules surgerules
      
      - name: Setup tools
        run: |
          wget "https://github.com/MetaCubeX/geo/releases/download/v1.1/geo-linux-amd64"
          chmod +x geo-linux-amd64
      
      - name: Download GeoSite
        run: |
          wget "https://github.com/Loyalsoldier/v2ray-rules-dat/releases/latest/download/geosite.dat"

      - name: Extract GeoSite
        run: ./geo-linux-amd64 unpack site geosite.dat -d v2rules/

      - name: Convert
        run: |
          cd v2rules || exit 1
          for FILE in ./*
          do 
          sed '' `grep "include:" $FILE | sed "s/include://g"` $FILE > $FILE.tmp
          grep "domain:" $FILE.tmp | sed -e "s/domain:/DOMAIN-SUFFIX,/g" -e "s/ @.*//g" > ../surgerules/$FILE.conf
          grep "keyword:" $FILE.tmp | sed -e "s/keyword:/DOMAIN-KEYWORD,/g" -e "s/ @.*//g" >> ../surgerules/$FILE.conf
          grep "full:" $FILE.tmp | sed -e "s/full:/DOMAIN,/g" -e "s/ @.*//g" >> ../surgerules/$FILE.conf
          rm $FILE.tmp
          done